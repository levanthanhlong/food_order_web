<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Trang Äáº·t CÆ¡m NhÃ¢n ViÃªn</title>
    <link href="/assets/css/home.css" rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <aside class="sidebar">
        <h2>ğŸ± Äáº·t CÆ¡m</h2>
        <ul>
          <li><a href="#" id="tab-food">ğŸ—“ï¸ MÃ³n Äƒn trong tuáº§n</a></li>
          <li><a href="#" id="tab-history">ğŸ•’ Lá»‹ch sá»­ Ä‘áº·t mÃ³n</a></li>
          <li><a href="/api/user/logout" class="logout">ğŸšª ÄÄƒng Xuáº¥t</a></li>
        </ul>
      </aside>
      <main class="content">
        <section id="foodListSection">
          <div id="hello-fullname">
            <!--  show hello user  -->
          </div>
          <div class="header-row">
            <h2>ğŸ—“ï¸ MÃ³n Äƒn trong tuáº§n nÃ y</h2>
            <div id="showMessage">
              <!-- show message of response -->
            </div>
          </div>

          <i>LÆ°u Ã½: Äáº·t cÆ¡m cháº­m nháº¥t trÆ°á»›c 10:00 am</i>
          <br />
          <div id="foodList" class="food-list">
            <!-- JS sáº½ render mÃ³n Äƒn á»Ÿ Ä‘Ã¢y -->
          </div>
        </section>
        <section id="historySection" style="display: none">
          <h2>ğŸ•’ Lá»‹ch sá»­ Ä‘áº·t mÃ³n</h2>
          <table id="orderHistoryTable">
            <thead>
              <tr>
                <th>STT</th>
                <th>TÃªn mÃ³n</th>
                <th>Sá»‘ lÆ°á»£ng</th>
                <th>NgÃ y cung cáº¥p</th>
                <th>Tráº¡ng thÃ¡i</th>
              </tr>
            </thead>
            <tbody id="orderHistoryBody">
              <!-- ÄÆ¡n hÃ ng sáº½ Ä‘Æ°á»£c Ä‘á»• vÃ o Ä‘Ã¢y -->
            </tbody>
          </table>
        </section>
      </main>
    </div>
  </body>
  <script>
    const showFullname = document.getElementById("hello-fullname");
    const foodList = document.getElementById("foodList");
    const foodSection = document.getElementById("foodListSection");
    const historySection = document.getElementById("historySection");
    const showMessage = document.getElementById("showMessage");

    document.getElementById("tab-food").addEventListener("click", () => {
      foodSection.style.display = "block";
      historySection.style.display = "none";
    });
    document.getElementById("tab-history").addEventListener("click", () => {
      foodSection.style.display = "none";
      historySection.style.display = "block";
      loadOrderHistory();
    });
    const token = localStorage.getItem("token");

    // function get user info
    async function fetchUserInfo() {
      try {
        const res = await fetch("/api/user/getUserInfo", {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });
        const data = await res.json();
        if (data.status === 1) {
          showFullname.innerText = `Xin chÃ o, ${data.data.fullname}`;
        } else {
          //alert("KhÃ´ng thá»ƒ táº£i thÃ´ng tin ngÆ°á»i dÃ¹ng!");
        }
      } catch (error) {
        // console.error("Lá»—i khi táº£i thÃ´ng tin ngÆ°á»i dÃ¹ng:", error);
        // const newDiv = document.createElement("div");
        // newDiv.textContent = error;
        // newDiv.style.padding = "10px";
        // newDiv.style.backgroundColor = "#d0f0c0";
        // newDiv.style.color = "red";

        // showMessage.appendChild(newDiv);
        // // XoÃ¡ sau 2 giÃ¢y
        // setTimeout(() => {
        //   showMessage.removeChild(newDiv);
        // }, 2000);
        alert("ÄÃ£ xáº£y ra lá»—i khi táº£i thÃ´ng tin ngÆ°á»i dÃ¹ng.");
      }
    }
    // // function get list of food items on this week
    async function fetchFoodItems() {
      try {
        const res = await fetch("/api/foodItems/getFoodItemsOnThisWeek");
        const data = await res.json();
        if (data.status === 1) {
          renderFoodItems(data.data);
        } else {
          //alert("KhÃ´ng thá»ƒ táº£i danh sÃ¡ch mÃ³n Äƒn!");
        }
      } catch (error) {
        console.error("Lá»—i:", error);
        //alert("CÃ³ lá»—i xáº£y ra khi táº£i mÃ³n Äƒn.");
      }
    }

    // // forEach food item
    async function renderFoodItems(items) {
      foodList.innerHTML = "";

      // Láº¥y danh sÃ¡ch Ä‘Æ¡n hÃ ng cá»§a user hiá»‡n táº¡i
      let orderedFoodIds = [];
      try {
        const orderRes = await fetch("/api/orders/getAllOrdersByUserId", {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        });

        const orderData = await orderRes.json();
        orderedFoodIds = orderData.data.map((order) => Number(order.food_id));
      } catch (error) {
        // const newDiv = document.createElement("div");
        // newDiv.textContent = "Lá»—i khi láº¥y danh sÃ¡ch Ä‘Æ¡n hÃ ng:";
        // newDiv.style.padding = "10px";
        // //newDiv.style.backgroundColor = "#d0f0c0";
        // newDiv.style.color = "red";

        // showMessage.appendChild(newDiv);
        // // XoÃ¡ sau 2 giÃ¢yr
        // setTimeout(() => {
        //   showMessage.removeChild(newDiv);
        // }, 2000);
        console.error("Lá»—i khi láº¥y danh sÃ¡ch Ä‘Æ¡n hÃ ng:", error);
      }

      const now = new Date();

      items.forEach((item) => {
        const card = document.createElement("div");
        card.className = "food-card";

        const isOrdered = orderedFoodIds.includes(Number(item.id));

        const availableDate = new Date(item.available_date);
        const deadline = new Date(
          availableDate.getFullYear(),
          availableDate.getMonth(),
          availableDate.getDate(),
          10,
          0,
          0 // 10:00:00 AM
        );

        const isPastDeadline = now > deadline;

        let actionHtml = "";
        if (isOrdered) {
          actionHtml = `<p class="ordered-text">âœ… ÄÃ£ Ä‘áº·t</p>`;
        } else if (isPastDeadline) {
          actionHtml = `<button class="order-btn" disabled style="background: #ccc; cursor: not-allowed;">â° QuÃ¡ háº¡n</button>`;
        } else {
          actionHtml = `<button class="order-btn" data-foodid="${item.id}" data-date="${item.available_date}">Äáº·t mÃ³n</button>`;
        }

        card.innerHTML = `
      <img src="${item.image_url}" alt="${item.name_food}" />
      <h3>${item.name_food}</h3>
      <p>MÃ´ táº£: ${item.description}</p>
      <p><strong>GiÃ¡:</strong> ${item.price}â‚«</p>
      <p><strong>NgÃ y:</strong> ${new Date(
        item.available_date
      ).toLocaleDateString("vi-VN")}</p>
      ${actionHtml}
    `;

        foodList.appendChild(card);

        // Gáº¯n sá»± kiá»‡n click náº¿u cÃ²n trong háº¡n vÃ  chÆ°a Ä‘áº·t
        if (!isOrdered && !isPastDeadline) {
          const orderBtn = card.querySelector(".order-btn");
          orderBtn.addEventListener("click", async () => {
            const foodId = item.id;
            const orderDate = item.available_date;
            const quantity = 1;
            const statusOrder = "ordered";

            try {
              const res = await fetch(`/api/orders/createOrder/${foodId}`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
                body: JSON.stringify({
                  quantity,
                  orderDate,
                  statusOrder,
                }),
              });

              const data = await res.json();
              if (data.status === 1) {
                // const newDiv = document.createElement("div");
                // newDiv.textContent = "âœ… Äáº·t mÃ³n thÃ nh cÃ´ng!";
                // newDiv.style.padding = "10px";
                // //newDiv.style.backgroundColor = "#d0f0c0";
                // newDiv.style.color = "red";

                // showMessage.appendChild(newDiv);
                // // XoÃ¡ sau 2 giÃ¢y
                // setTimeout(() => {
                //   showMessage.removeChild(newDiv);
                // }, 2000);
                // alert("âœ… Äáº·t mÃ³n thÃ nh cÃ´ng!");
                renderFoodItems(items); // Reload láº¡i danh sÃ¡ch sau khi Ä‘áº·t
              } else {
                // const newDiv = document.createElement("div");
                // newDiv.textContent = "KhÃ´ng thá»ƒ Ä‘áº·t mÃ³n: " + data.message;
                // newDiv.style.padding = "10px";
                // //newDiv.style.backgroundColor = "#d0f0c0";
                // newDiv.style.color = "red";

                // showMessage.appendChild(newDiv);
                // // XoÃ¡ sau 2 giÃ¢y
                // setTimeout(() => {
                //   showMessage.removeChild(newDiv);
                // }, 2000);
                alert("KhÃ´ng thá»ƒ Ä‘áº·t mÃ³n: " + data.message);
              }
            } catch (error) {
              console.error("Lá»—i khi Ä‘áº·t mÃ³n:", error);
              //alert("ÄÃ£ xáº£y ra lá»—i khi Ä‘áº·t mÃ³n!");
            }
          });
        }
      });
    }

    // get orders of user
    async function loadOrderHistory() {
      try {
        const response = await fetch("/api/orders/getAllOrdersByUserId", {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`, // hoáº·c nÆ¡i báº¡n lÆ°u JWT
          },
        });

        const data = await response.json();

        if (data.success) {
          const tbody = document.getElementById("orderHistoryBody");
          tbody.innerHTML = ""; // Clear cÅ©

          data.data.forEach((order, index) => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${order.name_food}</td>
          <td>${order.quantity}</td>
          <td>${new Date(order.order_date).toLocaleDateString()}</td>
          <td>${order.status === "ordered" ? "ÄÃ£ Ä‘áº·t" : "ChÆ°a Ä‘áº·t"}</td>
        `;

            tbody.appendChild(tr);
          });
        } else {
          alert("KhÃ´ng thá»ƒ táº£i lá»‹ch sá»­ Ä‘Æ¡n hÃ ng");
        }
      } catch (err) {
        console.error("Lá»—i khi láº¥y lá»‹ch sá»­ Ä‘Æ¡n hÃ ng:", err);
      }
    }

    // âœ… Gá»i cáº£ hai khi load trang
    document.addEventListener("DOMContentLoaded", () => {
      fetchUserInfo();
      fetchFoodItems();
    });
  </script>
</html>
